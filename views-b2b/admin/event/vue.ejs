var COMMON = {
  DOUBLE_CLICK_TIME_PERIOD: 250,
  DEFAULT_INDEX: -1,
  DEFAULT_AVATAR: "/assets/admin/img/avatars/default.png",
};

var itemBeforeEdit = {};
var prefix = 'admin/';
var modelName = "event";
var appModel = {
  modelName: modelName,
  prefix: prefix,
  data: {
    item: {
      id: '',
      limit: '1',
      signupCount: '0',
      price: '1',
      title: '',
      description: '',
      sellStartDate: '',
      sellEndDate: '',
      eventStartDate: '',
      eventEndDate: ''
    },
    items: [],
    option: {
      defaultSort: [[ 0, 'desc' ]],
    }
  },
  view: {
    table: {
      selectIndex: COMMON.DEFAULT_INDEX,
    },
  }
}

var ready = function () {
  $('.summernote').summernote({
    height: 180,
    dialogsInBody: true,
    lang: 'zh-TW',
    maximumImageFileSize: 1 * 1024 * 1024,
    toolbar: [
      ['style', ['bold', 'italic', 'underline', 'clear']],
      ['fontsize', ['fontsize']],
      ['color', ['color']],
      ['insert', ['picture', 'link']],
      ['para', ['ul', 'ol', 'paragraph']],
      ['misc', ['redo', 'undo', 'fullscreen']],
    ],
    callbacks: {
      onInit: function() {
        var self = this;
        setTimeout(function () {
          $(self).summernote('code', self.innerText);
          if(document.querySelector('.loading-wrapper.active'))
            document.querySelector('.loading-wrapper.active').classList.remove('active');
        }, 3000);
      },
      onImageUpload: function(files) {
      
        function onerror (err) {
          console.error(err);
          alert('錯誤，發生不明原因，無法上傳圖片。')
        }
        if(options.maximumImageFileSize < files[0].size) {
          messageApp.show({desc: '上傳圖片超過限制', type: 'error'});
        }
        var self = this;
        var formdata = new FormData();
        formdata.append('qquuid', files[0].name); 
        formdata.append('qqfilename', files[0].name); 
        formdata.append('qqtotalfilesize', files[0].size); 
        formdata.append('uploadPic', files[0]); 
        var xhr = new XMLHttpRequest();
        xhr.open('post', '/api/admin/upload');
        xhr.onload = function () {
          try {
            var json = JSON.parse(xhr.responseText);
            $(self).summernote('insertImage', json.data.url);
          } catch (err) {
            onerror(err);
          }
        };
        xhr.onerror = onerror;
        xhr.send(formdata);
      }
    }
  });
  
  if($('form')[0])
    $('form')[0].onsubmit =function (event) {
      var summernotes = $('.summernote');
      summernotes.each(function (index) {
        var summernote = summernotes.eq(index);
        var markup = summernote.summernote('code');
        appMain.data.item[summernote.attr('name')] = markup;
      });
      return true;
    };
};

/* TABLETOOLS */

<%- include ../default/vue.ejs %>
// 需要新增函式可以對 appMain 進行定義，如：
// appMain.log = function () {console.log("123")}
appMain.enableText = function () {
  $('textarea').attr('disabled', false);
}

appMain.enterDatetime = function () {
  $("input[name='sellStartDate']").datetimepicker({
    format: 'YYYY/MM/DD HH:mm',
    sideBySide: true
  });
  $("input[name='sellEndDate']").datetimepicker({
    format: 'YYYY/MM/DD HH:mm',
    sideBySide: true
  });
  $("input[name='eventStartDate']").datetimepicker({
    format: 'YYYY/MM/DD HH:mm',
    sideBySide: true
  });
  $("input[name='eventEndDate']").datetimepicker({
    format: 'YYYY/MM/DD HH:mm',
    sideBySide: true
  });
}

appMain.loadDateTimeScript = function(){

  loadScript("/assets/admin/js/plugin/moment/moment.min.js",function(){
    loadScript("/assets/admin/js/plugin/bootstrap-datetimepicker/bootstrap-datetimepicker.min.js", appMain.enterDatetime );
  });

}

appMain.createDateInit = function(){
  appModel.data.item.signupCount = 0;
  appModel.data.item.sellStartDate = "1999/04/18 00:00";
  appModel.data.item.eventStartDate = "1999/04/18 00:00";
  appModel.data.item.sellEndDate = "3333/04/18 00:00";
  appModel.data.item.eventEndDate = "3333/04/18 00:00";
}
